<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8" /><title>1&nbsp;Overview</title><link rel="stylesheet" type="text/css" href="../scribble.css" title="default" /><link rel="stylesheet" type="text/css" href="../racket.css" title="default" /><link rel="stylesheet" type="text/css" href="../scribble-style.css" title="default" /><script type="text/javascript" src="../scribble-common.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="doc-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist" style="margin-bottom: 1em;"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9660;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">The Racket Foreign Interface</a></td></tr></table></div><div class="tocviewsublisttop" style="display: block;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Overview</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="Loading_Foreign_Libraries.html" class="tocviewlink" data-pltdoc="x">Loading Foreign Libraries</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="types.html" class="tocviewlink" data-pltdoc="x">C Types</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="foreign_pointer-funcs.html" class="tocviewlink" data-pltdoc="x">Pointer Functions</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="Derived_Utilities.html" class="tocviewlink" data-pltdoc="x">Derived Utilities</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="Miscellaneous_Support.html" class="tocviewlink" data-pltdoc="x">Miscellaneous Support</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="foreign_c-only.html" class="tocviewlink" data-pltdoc="x">Unexported Primitive Functions</a></td></tr><tr><td align="right"></td><td><a href="doc-bibliography.html" class="tocviewlink" data-pltdoc="x">Bibliography</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" data-pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9658;</a></td><td>1&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Overview</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">1.1&nbsp;</td><td><a href="#%28part._.Libraries__.C_.Types__and_.Objects%29" class="tocviewlink" data-pltdoc="x">Libraries, C Types, and Objects</a></td></tr><tr><td align="right">1.2&nbsp;</td><td><a href="#%28part._.Function-.Type_.Bells_and_.Whistles%29" class="tocviewlink" data-pltdoc="x">Function-<wbr></wbr>Type Bells and Whistles</a></td></tr><tr><td align="right">1.3&nbsp;</td><td><a href="#%28part._.By-.Reference_.Arguments%29" class="tocviewlink" data-pltdoc="x">By-<wbr></wbr>Reference Arguments</a></td></tr><tr><td align="right">1.4&nbsp;</td><td><a href="#%28part._.C_.Structs%29" class="tocviewlink" data-pltdoc="x">C Structs</a></td></tr><tr><td align="right">1.5&nbsp;</td><td><a href="#%28part._.Pointers_and_.Manual_.Allocation%29" class="tocviewlink" data-pltdoc="x">Pointers and Manual Allocation</a></td></tr><tr><td align="right">1.6&nbsp;</td><td><a href="#%28part._.Pointers_and_.G.C-.Managed_.Allocation%29" class="tocviewlink" data-pltdoc="x">Pointers and GC-<wbr></wbr>Managed Allocation</a></td></tr><tr><td align="right">1.7&nbsp;</td><td><a href="#%28part._.Reliable_.Release_of_.Resources%29" class="tocviewlink" data-pltdoc="x">Reliable Release of Resources</a></td></tr><tr><td align="right">1.8&nbsp;</td><td><a href="#%28part._.More_.Examples%29" class="tocviewlink" data-pltdoc="x">More Examples</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">1.1<tt>&nbsp;</tt></span><a href="#(part._.Libraries__.C_.Types__and_.Objects)" class="tocsubseclink" data-pltdoc="x">Libraries, C Types, and Objects</a></td></tr><tr><td><span class="tocsublinknumber">1.2<tt>&nbsp;</tt></span><a href="#(part._.Function-.Type_.Bells_and_.Whistles)" class="tocsubseclink" data-pltdoc="x">Function-<wbr></wbr>Type Bells and Whistles</a></td></tr><tr><td><span class="tocsublinknumber">1.3<tt>&nbsp;</tt></span><a href="#(part._.By-.Reference_.Arguments)" class="tocsubseclink" data-pltdoc="x">By-<wbr></wbr>Reference Arguments</a></td></tr><tr><td><span class="tocsublinknumber">1.4<tt>&nbsp;</tt></span><a href="#(part._.C_.Structs)" class="tocsubseclink" data-pltdoc="x">C Structs</a></td></tr><tr><td><span class="tocsublinknumber">1.5<tt>&nbsp;</tt></span><a href="#(part._.Pointers_and_.Manual_.Allocation)" class="tocsubseclink" data-pltdoc="x">Pointers and Manual Allocation</a></td></tr><tr><td><span class="tocsublinknumber">1.6<tt>&nbsp;</tt></span><a href="#(part._.Pointers_and_.G.C-.Managed_.Allocation)" class="tocsubseclink" data-pltdoc="x">Pointers and GC-<wbr></wbr>Managed Allocation</a></td></tr><tr><td><span class="tocsublinknumber">1.7<tt>&nbsp;</tt></span><a href="#(part._.Reliable_.Release_of_.Resources)" class="tocsubseclink" data-pltdoc="x">Reliable Release of Resources</a></td></tr><tr><td><span class="tocsublinknumber">1.8<tt>&nbsp;</tt></span><a href="#(part._.More_.Examples)" class="tocsubseclink" data-pltdoc="x">More Examples</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><form class="searchform"><input class="searchbox" style="color: #888;" type="text" value="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;5.3.2&quot;, &quot;../&quot;);" onfocus="this.style.color=&quot;black&quot;; this.style.textAlign=&quot;left&quot;; if (this.value == &quot;...search manuals...&quot;) this.value=&quot;&quot;;" onblur="if (this.value.match(/^ *$/)) { this.style.color=&quot;#888&quot;; this.style.textAlign=&quot;center&quot;; this.value=&quot;...search manuals...&quot;; }" /></form>&nbsp;&nbsp;<a href="../index.html" title="up to the documentation top" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;5.3.2&quot;);">top</a></span><span class="navright">&nbsp;&nbsp;<a href="index.html" title="backward to &quot;The Racket Foreign Interface&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;The Racket Foreign Interface&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="Loading_Foreign_Libraries.html" title="forward to &quot;2 Loading Foreign Libraries&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h3>1<tt>&nbsp;</tt><a name="(part._intro)"></a>Overview</h3><p>Although using the FFI requires writing no new C code, it provides
very little insulation against the issues that C programmers face
related to safety and memory management. An FFI programmer must be
particularly aware of memory management issues for data that spans the
Racket&ndash;C divide. Thus, this manual relies in many ways on the
information in <a href="../inside/index.html" data-pltdoc="x">Inside: Racket C API</a>, which defines how Racket
interacts with C APIs in general.</p><p>Since using the FFI entails many safety concerns that Racket
programmers can normally ignore, the library name includes
<span class="RktSym">unsafe</span>. Importing the library macro should be
considered as a declaration that your code is itself unsafe, therefore
can lead to serious problems in case of bugs: it is your
responsibility to provide a safe interface. If your library provides
an unsafe interface, then it should have <span class="RktSym">unsafe</span> in its
name, too.</p><p>For more information on the motivation and design of the Racket FFI,
see [<a href="doc-bibliography.html#%28cite._.Barzilay04%29" data-pltdoc="x">Barzilay04</a>].</p><h4>1.1<tt>&nbsp;</tt><a name="(part._.Libraries__.C_.Types__and_.Objects)"></a>Libraries, C Types, and Objects</h4><p>To use the FFI, you must have in mind</p><ul><li><p>a particular library from which you want to access a function
or value, </p></li><li><p>a particular symbol exported by the file, and</p></li><li><p>the C-level type (typically a function type) of the exported
symbol.</p></li></ul><p>The library corresponds to a file with a suffix such as
<span class="stt">".dll"</span>, <span class="stt">".so"</span>, or <span class="stt">".dylib"</span> (depending on
the platform), or it might be a library within a <span class="stt">".framework"</span>
directory on Mac OS X.</p><p>Knowing the library&rsquo;s name and/or path is often the trickiest part of
using the FFI.  Sometimes, when using a library name without a path
prefix or file suffix, the library file can be located automatically,
especially on Unix. See <span class="RktSym"><a href="Loading_Foreign_Libraries.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29._ffi-lib%29%29" class="RktValLink" data-pltdoc="x">ffi-lib</a></span> for advice.</p><p>The <span class="RktSym"><a href="Loading_Foreign_Libraries.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29._ffi-lib%29%29" class="RktValLink" data-pltdoc="x">ffi-lib</a></span> function gets a handle to a library. To extract
exports of the library, it&rsquo;s simplest to use
<span class="RktSym"><a href="Defining_Bindings.html#%28form._%28%28lib._ffi%2Funsafe%2Fdefine..rkt%29._define-ffi-definer%29%29" class="RktStxLink" data-pltdoc="x">define-ffi-definer</a></span> from the <a href="Defining_Bindings.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">ffi/unsafe/define</span></a>
library:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><a href="../guide/Module_Syntax.html#%28part._hash-lang%29" class="RktModLink" data-pltdoc="x"><span class="RktMod">#lang</span></a><span class="hspace">&nbsp;</span><a href="../reference/index.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">racket/base</span></a></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29" class="RktStxLink" data-pltdoc="x">require</a></span><span class="hspace">&nbsp;</span><span class="RktSym">ffi/unsafe</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">ffi/unsafe/define</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="Defining_Bindings.html#%28form._%28%28lib._ffi%2Funsafe%2Fdefine..rkt%29._define-ffi-definer%29%29" class="RktStxLink" data-pltdoc="x">define-ffi-definer</a></span><span class="hspace">&nbsp;</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="Loading_Foreign_Libraries.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29._ffi-lib%29%29" class="RktValLink" data-pltdoc="x">ffi-lib</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"libcurses"</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>This <span class="RktSym"><a href="Defining_Bindings.html#%28form._%28%28lib._ffi%2Funsafe%2Fdefine..rkt%29._define-ffi-definer%29%29" class="RktStxLink" data-pltdoc="x">define-ffi-definer</a></span> declaration introduces a
<span class="RktSym">define-curses</span> form for binding a Racket name to a value
extracted from <span class="stt">"libcurses"</span>&#8212;<wbr></wbr>which might be located
at <span class="stt">"/usr/lib/libcurses.so"</span>, depending on
the platform.</p><p>To use <span class="RktSym">define-curses</span>, we need the names and C types of
functions from <span class="stt">"libcurses"</span>. We&rsquo;ll start by using the
following functions:</p><p><table cellspacing="0"><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">WINDOW* initscr(void);</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">int waddstr(WINDOW *win, char *str);</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">int wrefresh(WINDOW *win);</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">int endwin(void);</span></span></p></td></tr></table></p><p>We make these functions callable from Racket as follows:</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>By convention, an underscore prefix
indicates a representation of a C type (such as <span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span>) or a
constructor of such representations (such as <span class="RktSym"><a href="foreign_tagged-pointers.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__cpointer%29%29" class="RktValLink" data-pltdoc="x">_cpointer</a></span>).</p></blockquote></blockquote></blockquote><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">_WINDOW-pointer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_tagged-pointers.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__cpointer%29%29" class="RktValLink" data-pltdoc="x">_cpointer</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">WINDOW</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">initscr</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym">_WINDOW-pointer</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">waddstr</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym">_WINDOW-pointer</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="String_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__string%29%29" class="RktValLink" data-pltdoc="x">_string</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">wrefresh</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym">_WINDOW-pointer</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">endwin</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>The definition of <span class="RktSym">_WINDOW-pointer</span> creates a Racket value that
reflects a C type via <span class="RktSym"><a href="foreign_tagged-pointers.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__cpointer%29%29" class="RktValLink" data-pltdoc="x">_cpointer</a></span>, which creates a type
representation for a pointer type&#8212;<wbr></wbr>usually one that is opaque. The
<span class="RktVal">'</span><span class="RktVal">WINDOW</span> argument could have been any value, but by
convention, we use a symbol matching the C base type.</p><p>Each <span class="RktSym">define-curses</span> form uses the given identifier as both the
name of the library export and the Racket identifier to
bind.<span class="refelem"><span class="refcolumn"><span class="refcontent">An optional <span class="RktPn">#:c-id</span> clause for
<span class="RktSym">define-curses</span> can specify a name for the library export that
is different from the Racket identifier to bind.</span></span></span> The <span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="stt"> </span><span class="RktSym"><a href="../reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29" class="RktStxLink" data-pltdoc="x">...</a></span><span class="stt"> </span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="stt"> </span><span class="RktSym"><a href="../reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29" class="RktStxLink" data-pltdoc="x">...</a></span><span class="RktPn">)</span> part of each definition describes the C type of the
exported function, since the library file does not encode that
information for its exports. The types listed to the left of <span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span> are the
argument types, while the type to the right of <span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span> is the
result type. The pre-defined <span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span> type naturally corresponds
to the <span class="stt">int</span> C type, while <span class="RktSym"><a href="String_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__string%29%29" class="RktValLink" data-pltdoc="x">_string</a></span> corresponds to the
<span class="stt">char*</span> type when it is intended as a string to read.</p><p>At this point, <span class="RktSym">initscr</span>, <span class="RktSym">waddstr</span>, <span class="RktSym">wrefresh</span>,
and <span class="RktSym">endwin</span> are normal Racket bindings to Racket functions
(that happen to call C functions), and so they can be exported from
the defining module or called directly:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">initscr</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/void.html#%28def._%28%28quote._~23~25kernel%29._void%29%29" class="RktValLink" data-pltdoc="x">void</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">waddstr</span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="hspace">&nbsp;</span><span class="RktVal">"Hello"</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/void.html#%28def._%28%28quote._~23~25kernel%29._void%29%29" class="RktValLink" data-pltdoc="x">void</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">wrefresh</span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#%28def._%28%28quote._~23~25kernel%29._sleep%29%29" class="RktValLink" data-pltdoc="x">sleep</a></span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/void.html#%28def._%28%28quote._~23~25kernel%29._void%29%29" class="RktValLink" data-pltdoc="x">void</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">endwin</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><h4>1.2<tt>&nbsp;</tt><a name="(part._.Function-.Type_.Bells_and_.Whistles)"></a>Function-Type Bells and Whistles</h4><p>Our initial use of functions like <span class="RktSym">waddstr</span> is sloppy, because
we ignore return codes. C functions often return error
codes, and checking them is a pain. A better approach is to build the
check into the <span class="RktSym">waddstr</span> binding and raise an exception when
the code is non-zero.</p><p>The <span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span> function-type constructor includes many options to
help convert C functions to nicer Racket functions. We can use some of
those features to convert return codes into either <a href="../guide/void_undefined.html" class="RktModLink" data-pltdoc="x"><span class="nobreak"><span class="RktRes">#&lt;void&gt;</span></span></a> or an
exception:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">check</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym">who</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/when_unless.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._unless%29%29" class="RktStxLink" data-pltdoc="x">unless</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/number-types.html#%28def._%28%28quote._~23~25kernel%29._zero~3f%29%29" class="RktValLink" data-pltdoc="x">zero?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/exns.html#%28def._%28%28quote._~23~25kernel%29._error%29%29" class="RktValLink" data-pltdoc="x">error</a></span><span class="hspace">&nbsp;</span><span class="RktSym">who</span><span class="hspace">&nbsp;</span><span class="RktVal">"failed: ~a"</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">initscr</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym">_WINDOW-pointer</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">waddstr</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym">_WINDOW-pointer</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="String_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__string%29%29" class="RktValLink" data-pltdoc="x">_string</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">r</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">check</span><span class="hspace">&nbsp;</span><span class="RktSym">r</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">waddstr</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">wrefresh</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym">_WINDOW-pointer</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">r</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">check</span><span class="hspace">&nbsp;</span><span class="RktSym">r</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">wrefresh</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">endwin</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">r</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">check</span><span class="hspace">&nbsp;</span><span class="RktSym">r</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">endwin</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Using <span class="RktPn">(</span><span class="RktSym">r</span><span class="stt"> </span><span class="RktSym">:</span><span class="stt"> </span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">)</span> as a result type gives the local name
<span class="RktSym">r</span> to the C function&rsquo;s result. This name is then used in the
result post-processing expression that is specified after a second
<span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span> in the <span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span> form.</p><h4>1.3<tt>&nbsp;</tt><a name="(part._.By-.Reference_.Arguments)"></a>By-Reference Arguments</h4><p>To get mouse events from <span class="stt">"libcurses"</span>, we must explicitly
enable them through the <span class="RktSym">mousemask</span> function:</p><p><table cellspacing="0"><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">typedef unsigned long mmask_t;</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">#define BUTTON1_CLICKED 004L</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt"></span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">mmask_t mousemask(mmask_t newmask, mmask_t *oldmask);</span></span></p></td></tr></table></p><p>Setting <span class="RktSym">BUTTON1_CLICKED</span> in the mask enables button-click
events.  At the same time, <span class="RktSym">mousemask</span> returns the current mask
by installing it into the pointer provided as its second
argument.</p><p>Since these kinds of call-by-reference interfaces are common in C,
<span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span> cooperates with a <span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__ptr%29%29" class="RktStxLink" data-pltdoc="x">_ptr</a></span> form to automatically
allocate space for a by-reference argument and extract the value put
there by the C function. Give the extracted value name to use in the
post-processing expression. The post-processing expression can combine
the by-reference result with the function&rsquo;s direct result (which, in
this case, reports a subset of the given mask that is actually
supported).</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">_mmask_t</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__ulong%29%29" class="RktValLink" data-pltdoc="x">_ulong</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">mousemask</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym">_mmask_t</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">o</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__ptr%29%29" class="RktStxLink" data-pltdoc="x">_ptr</a></span><span class="hspace">&nbsp;</span><span class="RktSym">o</span><span class="hspace">&nbsp;</span><span class="RktSym">_mmask_t</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">r</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktSym">_mmask_t</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/values.html#%28def._%28%28quote._~23~25kernel%29._values%29%29" class="RktValLink" data-pltdoc="x">values</a></span><span class="hspace">&nbsp;</span><span class="RktSym">o</span><span class="hspace">&nbsp;</span><span class="RktSym">r</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">BUTTON1_CLICKED</span><span class="hspace">&nbsp;</span><span class="RktVal">4</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28quote._~23~25kernel%29._define-values%29%29" class="RktStxLink" data-pltdoc="x">define-values</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">old</span><span class="hspace">&nbsp;</span><span class="RktSym">supported</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">mousemask</span><span class="hspace">&nbsp;</span><span class="RktSym">BUTTON1_CLICKED</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><h4>1.4<tt>&nbsp;</tt><a name="(part._.C_.Structs)"></a>C Structs</h4><p>Assuming that mouse events are supported, the <span class="stt">"libcurses"</span>
library reports them via <span class="RktSym">getmouse</span>, which accepts a pointer to
a <span class="stt">MEVENT</span> struct to fill with mouse-event information:</p><p><table cellspacing="0"><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">typedef struct {</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">short id;</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">int x, y, z;</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">mmask_t bstate;</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">} MEVENT;</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt"></span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">int getmouse(MEVENT *event);</span></span></p></td></tr></table></p><p>To work with <span class="stt">MEVENT</span> values, we use <span class="RktSym"><a href="C_Struct_Types.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29._define-cstruct%29%29" class="RktStxLink" data-pltdoc="x">define-cstruct</a></span>:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="C_Struct_Types.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29._define-cstruct%29%29" class="RktStxLink" data-pltdoc="x">define-cstruct</a></span><span class="hspace">&nbsp;</span><span class="RktSym">_MEVENT</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">id</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__short%29%29" class="RktValLink" data-pltdoc="x">_short</a></span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">y</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">z</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">bstate</span><span class="hspace">&nbsp;</span><span class="RktSym">_mmask_t</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>This definition binds many names in the same way that
<span class="RktSym"><a href="../reference/define-struct.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define-struct%29%29" class="RktStxLink" data-pltdoc="x">define-struct</a></span> binds many names: <span class="RktSym">_MEVENT</span> is a C type
representing the struct type, <span class="RktSym">_MEVENT-pointer</span> is a C type
representing a pointer to a <span class="RktSym">_MEVENT</span>, <span class="RktSym">make-MEVENT</span>
constructs a <span class="RktSym">_MEVENT</span> value, <span class="RktSym">MEVENT-x</span> extracts
the <span class="RktSym">x</span> fields from an <span class="RktSym">_MEVENT</span> value, and so on.</p><p>With this C struct declaration, we can define the function type for
<span class="RktSym">getmouse</span>. The simplest approach is to define
<span class="RktSym">getmouse</span> to accept an <span class="RktSym">_MEVENT-pointer</span>, and then explicitly
allocate the <span class="RktSym">_MEVENT</span> value before calling <span class="RktSym">getmouse</span>:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">getmouse</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym">_MEVENT-pointer</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">m</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-MEVENT</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/when_unless.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._when%29%29" class="RktStxLink" data-pltdoc="x">when</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/number-types.html#%28def._%28%28quote._~23~25kernel%29._zero~3f%29%29" class="RktValLink" data-pltdoc="x">zero?</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">getmouse</span><span class="hspace">&nbsp;</span><span class="RktSym">m</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">use </span><span class="RktSym">m</span><span class="RktCmt">...</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktSym">....</span><span class="RktPn">)</span></td></tr></table></blockquote><p>For a more Racket-like function, use <span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__ptr%29%29" class="RktStxLink" data-pltdoc="x">_ptr</a></span><span class="stt"> </span><span class="RktSym">o</span><span class="stt"> </span><span class="RktSym">_MEVENT</span><span class="RktPn">)</span> and a
post-processing expression:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">getmouse</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">m</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__ptr%29%29" class="RktStxLink" data-pltdoc="x">_ptr</a></span><span class="hspace">&nbsp;</span><span class="RktSym">o</span><span class="hspace">&nbsp;</span><span class="RktSym">_MEVENT</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">r</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/if.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._and%29%29" class="RktStxLink" data-pltdoc="x">and</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/number-types.html#%28def._%28%28quote._~23~25kernel%29._zero~3f%29%29" class="RktValLink" data-pltdoc="x">zero?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">r</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">m</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">waddstr</span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Writing.html#%28def._%28%28quote._~23~25kernel%29._format%29%29" class="RktValLink" data-pltdoc="x">format</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"click me fast..."</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">wrefresh</span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#%28def._%28%28quote._~23~25kernel%29._sleep%29%29" class="RktValLink" data-pltdoc="x">sleep</a></span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">m</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">getmouse</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/when_unless.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._when%29%29" class="RktStxLink" data-pltdoc="x">when</a></span><span class="hspace">&nbsp;</span><span class="RktSym">m</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">waddstr</span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Writing.html#%28def._%28%28quote._~23~25kernel%29._format%29%29" class="RktValLink" data-pltdoc="x">format</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"at ~a,~a"</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">MEVENT-x</span><span class="hspace">&nbsp;</span><span class="RktSym">m</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">MEVENT-y</span><span class="hspace">&nbsp;</span><span class="RktSym">m</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">wrefresh</span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/threads.html#%28def._%28%28quote._~23~25kernel%29._sleep%29%29" class="RktValLink" data-pltdoc="x">sleep</a></span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">endwin</span><span class="RktPn">)</span></td></tr></table></blockquote><p>The difference between <span class="RktSym">_MEVENT-pointer</span> and <span class="RktSym">_MEVENT</span>
is crucial. Using <span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__ptr%29%29" class="RktStxLink" data-pltdoc="x">_ptr</a></span><span class="stt"> </span><span class="RktSym">o</span><span class="stt"> </span><span class="RktSym">_MEVENT-pointer</span><span class="RktPn">)</span> would allocate
only enough space for a pointer to an <span class="stt">MEVENT</span> struct, which is
not enough space for an <span class="stt">MEVENT</span> struct.</p><h4>1.5<tt>&nbsp;</tt><a name="(part._.Pointers_and_.Manual_.Allocation)"></a>Pointers and Manual Allocation</h4><p>To get text from the user instead of a mouse click, <span class="RktVal">"libcurses"</span>
provides <span class="RktSym">wgetnstr</span>:</p><p><table cellspacing="0"><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">int wgetnstr(WINDOW *win, char *str, int n);</span></span></p></td></tr></table></p><p>While the <span class="stt">char*</span> argument to <span class="RktSym">waddstr</span> is treated as a
nul-terminated string, the <span class="stt">char*</span> argument to <span class="RktSym">wgetnstr</span>
is treated as a buffer whose size is indicated by the final <span class="stt">int</span>
argument. The C type <span class="RktSym"><a href="String_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__string%29%29" class="RktValLink" data-pltdoc="x">_string</a></span> does not work for such
buffers.</p><p>One way to approach this function from Racket is to describe the
arguments in their rawest form, using plain <span class="RktSym"><a href="Pointer_Types.html#%28def._%28%28quote._~23~25foreign%29.__pointer%29%29" class="RktValLink" data-pltdoc="x">_pointer</a></span> for the
second argument to <span class="RktSym">wgetnstr</span>:</p><p><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="stt"> </span><span class="RktSym">wgetnstr</span><span class="stt"> </span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="stt"> </span><span class="RktSym">_WINDOW-pointer</span><span class="stt"> </span><span class="RktSym"><a href="Pointer_Types.html#%28def._%28%28quote._~23~25foreign%29.__pointer%29%29" class="RktValLink" data-pltdoc="x">_pointer</a></span><span class="stt"> </span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="stt"> </span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="stt"> </span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">)</span><span class="RktPn">)</span></p><p>To call this raw version of <span class="RktSym">wgetnstr</span>, allocate memory, zero
it, and pass the size minus one (to leave room a nul
terminator) to <span class="RktSym">wgetnstr</span>:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="hspace">&nbsp;</span><span class="RktVal">256</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">buffer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._malloc%29%29" class="RktValLink" data-pltdoc="x">malloc</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">raw</span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._memset%29%29" class="RktValLink" data-pltdoc="x">memset</a></span><span class="hspace">&nbsp;</span><span class="RktSym">buffer</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/void.html#%28def._%28%28quote._~23~25kernel%29._void%29%29" class="RktValLink" data-pltdoc="x">void</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">wgetnstr</span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="hspace">&nbsp;</span><span class="RktSym">buffer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._sub1%29%29" class="RktValLink" data-pltdoc="x">sub1</a></span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>When <span class="RktSym">wgetnstr</span> returns, it has written bytes to
<span class="RktSym">buffer</span>. At that point, we can use <span class="RktSym"><a href="Miscellaneous_Support.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29._cast%29%29" class="RktValLink" data-pltdoc="x">cast</a></span> to convert the
value from a raw pointer to a string:</p><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym"><a href="Miscellaneous_Support.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29._cast%29%29" class="RktValLink" data-pltdoc="x">cast</a></span><span class="hspace">&nbsp;</span><span class="RktSym">buffer</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Pointer_Types.html#%28def._%28%28quote._~23~25foreign%29.__pointer%29%29" class="RktValLink" data-pltdoc="x">_pointer</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="String_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__string%29%29" class="RktValLink" data-pltdoc="x">_string</a></span><span class="RktPn">)</span></p></blockquote><p>Conversion via the <span class="RktSym"><a href="String_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__string%29%29" class="RktValLink" data-pltdoc="x">_string</a></span> type causes the data refereced by
the original pointer to be copied (and UTF-8 decoded), so the memory
referenced by <span class="RktSym">buffer</span> is no longer needed. Memory allocated
with <span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._malloc%29%29" class="RktValLink" data-pltdoc="x">malloc</a></span><span class="stt"> </span><span class="RktVal">'</span><span class="RktVal">raw</span><span class="stt"> </span><span class="RktSym"><a href="../reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29" class="RktStxLink" data-pltdoc="x">...</a></span><span class="RktPn">)</span> must be released with <span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._free%29%29" class="RktValLink" data-pltdoc="x">free</a></span>:</p><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._free%29%29" class="RktValLink" data-pltdoc="x">free</a></span><span class="hspace">&nbsp;</span><span class="RktSym">buffer</span><span class="RktPn">)</span></p></blockquote><h4>1.6<tt>&nbsp;</tt><a name="(part._.Pointers_and_.G.C-.Managed_.Allocation)"></a>Pointers and GC-Managed Allocation</h4><p>Instead of allocating <span class="RktSym">buffer</span> with <span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._malloc%29%29" class="RktValLink" data-pltdoc="x">malloc</a></span><span class="stt"> </span><span class="RktVal">'</span><span class="RktVal">raw</span><span class="stt"> </span><span class="RktSym"><a href="../reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29" class="RktStxLink" data-pltdoc="x">...</a></span><span class="RktPn">)</span>,
we could have allocated it with <span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._malloc%29%29" class="RktValLink" data-pltdoc="x">malloc</a></span><span class="stt"> </span><span class="RktVal">'</span><span class="RktVal">atomic</span><span class="stt"> </span><span class="RktSym"><a href="../reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29" class="RktStxLink" data-pltdoc="x">...</a></span><span class="RktPn">)</span>:</p><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">buffer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._malloc%29%29" class="RktValLink" data-pltdoc="x">malloc</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">atomic</span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="RktPn">)</span><span class="RktPn">)</span></p></blockquote><p>Memory allocated with <span class="RktVal">'</span><span class="RktVal">atomic</span> is managed by the garbage
collector, so <span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._free%29%29" class="RktValLink" data-pltdoc="x">free</a></span> is neither necessary nor allowed when the
memory referenced by <span class="RktSym">buffer</span> is no longer needed. Instead,
when <span class="RktSym">buffer</span> becomes inaccessible, the allocated memory will
be reclaimed automatically.</p><p>Allowing the garbage collector (GC) to manage memory is usually
preferable.  It&rsquo;s easy to forget to call <span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._free%29%29" class="RktValLink" data-pltdoc="x">free</a></span>, and exceptions
or thread termination can easily skip a <span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._free%29%29" class="RktValLink" data-pltdoc="x">free</a></span>.</p><p>At the same time, using GC-managed memory adds a different burden on
the programmer: data managed by the GC may be moved to a new address
as the GC compacts allocated objects to avoid fragmentation. C
functions, meanwhile, expect to receive pointers to objects that will
stay put.</p><p>Fortunately, unless a C function calls back into the Racket run-time
system (perhaps through a function that is provided as an argument),
no garbage collection will happen between the time that a C function
is called and the time that the function returns.</p><p>Let&rsquo;s look a few possibilities related to allocation and pointers:</p><ul><li><p>Ok:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._malloc%29%29" class="RktValLink" data-pltdoc="x">malloc</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">atomic</span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">wgetnstr</span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._sub1%29%29" class="RktValLink" data-pltdoc="x">sub1</a></span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Although the data allocated by <span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._malloc%29%29" class="RktValLink" data-pltdoc="x">malloc</a></span> can move
around, <span class="RktSym">p</span> will always point to it, and no garbage collection
will happen between the time that the address is extracted form
<span class="RktSym">p</span> to pass to <span class="RktSym">wgetnstr</span> and the time that
<span class="RktSym">wgetnstr</span> returns.</p></li><li><p>Bad:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._malloc%29%29" class="RktValLink" data-pltdoc="x">malloc</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">atomic</span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">i</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="Miscellaneous_Support.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29._cast%29%29" class="RktValLink" data-pltdoc="x">cast</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Pointer_Types.html#%28def._%28%28quote._~23~25foreign%29.__pointer%29%29" class="RktValLink" data-pltdoc="x">_pointer</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__intptr%29%29" class="RktValLink" data-pltdoc="x">_intptr</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">wgetnstr</span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="Miscellaneous_Support.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29._cast%29%29" class="RktValLink" data-pltdoc="x">cast</a></span><span class="hspace">&nbsp;</span><span class="RktSym">i</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__intptr%29%29" class="RktValLink" data-pltdoc="x">_intptr</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Pointer_Types.html#%28def._%28%28quote._~23~25foreign%29.__pointer%29%29" class="RktValLink" data-pltdoc="x">_pointer</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._sub1%29%29" class="RktValLink" data-pltdoc="x">sub1</a></span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>The data referenced by <span class="RktSym">p</span> can move after the
address is converted to an integer, in which case <span class="RktSym">i</span> cast
back to a pointer will be the wrong address.</p><p>Obviously, casting a pointer to an integer is generally a bad idea,
but the cast simulates another possibility, which is passing the
pointer to a C function that retains the pointer in its own private
store for later use. Such private storage is invisible to the Racket
GC, so it has the same effect as casting the pointer to an integer.</p></li><li><p>Ok:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._malloc%29%29" class="RktValLink" data-pltdoc="x">malloc</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">atomic</span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p2</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._ptr-add%29%29" class="RktValLink" data-pltdoc="x">ptr-add</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktVal">4</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">wgetnstr</span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="hspace">&nbsp;</span><span class="RktSym">p2</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._-%29%29" class="RktValLink" data-pltdoc="x"><span class="nobreak">-</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>The pointer <span class="RktSym">p2</span> retains the original reference and
only adds the <span class="RktVal">4</span> at the last minute before calling
<span class="RktSym">wgetnstr</span> (i.e., after the point that garbage collection is
allowed).</p></li><li><p>Ok:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._malloc%29%29" class="RktValLink" data-pltdoc="x">malloc</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">atomic-interior</span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">i</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="Miscellaneous_Support.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29._cast%29%29" class="RktValLink" data-pltdoc="x">cast</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Pointer_Types.html#%28def._%28%28quote._~23~25foreign%29.__pointer%29%29" class="RktValLink" data-pltdoc="x">_pointer</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__intptr%29%29" class="RktValLink" data-pltdoc="x">_intptr</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">wgetnstr</span><span class="hspace">&nbsp;</span><span class="RktSym">win</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="Miscellaneous_Support.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29._cast%29%29" class="RktValLink" data-pltdoc="x">cast</a></span><span class="hspace">&nbsp;</span><span class="RktSym">i</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__intptr%29%29" class="RktValLink" data-pltdoc="x">_intptr</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Pointer_Types.html#%28def._%28%28quote._~23~25foreign%29.__pointer%29%29" class="RktValLink" data-pltdoc="x">_pointer</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._sub1%29%29" class="RktValLink" data-pltdoc="x">sub1</a></span><span class="hspace">&nbsp;</span><span class="RktSym">SIZE</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>This is ok assuming that <span class="RktSym">p</span> itself stays accessible, so that
the data it references isn&rsquo;t reclaimed. Allocating with
<span class="RktVal">'</span><span class="RktVal">atomic-interior</span> puts data at a particular address and
keeps it there.  A garbage collection will not change the address in
<span class="RktSym">p</span>, and so <span class="RktSym">i</span> (cast back to a pointer) will always
refer to the data.</p></li></ul><p>Keep in mind that C struct constructors like <span class="RktSym">make-MEVENT</span> are
effectively the same as <span class="RktPn">(</span><span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._malloc%29%29" class="RktValLink" data-pltdoc="x">malloc</a></span><span class="stt"> </span><span class="RktVal">'</span><span class="RktVal">atomic</span><span class="stt"> </span><span class="RktSym"><a href="../reference/stx-patterns.html#%28form._%28%28lib._racket%2Fprivate%2Fstxcase-scheme..rkt%29._......%29%29" class="RktStxLink" data-pltdoc="x">...</a></span><span class="RktPn">)</span>; the result values
can move in memory during a garbage collection.  The same is true of
byte strings allocated with <span class="RktSym"><a href="../reference/bytestrings.html#%28def._%28%28quote._~23~25kernel%29._make-bytes%29%29" class="RktValLink" data-pltdoc="x">make-bytes</a></span>, which (as a
convenience) can be used directly as a pointer value (unlike character
strings, which are always copied for UTF-8 encoding or decoding).</p><p>For more information about memory management and garbage collection,
see <a href="../inside/im_memoryalloc.html" data-pltdoc="x">Memory Allocation</a> in
<a href="../inside/index.html" data-pltdoc="x">Inside: Racket C API</a>.</p><h4>1.7<tt>&nbsp;</tt><a name="(part._.Reliable_.Release_of_.Resources)"></a>Reliable Release of Resources</h4><p>Using GC-managed memory saves you from manual <span class="RktSym"><a href="foreign_pointer-funcs.html#%28def._%28%28quote._~23~25foreign%29._free%29%29" class="RktValLink" data-pltdoc="x">free</a></span>s for plain
memory blocks, but C libraries often allocate resources and require a
matching call to a function that releases the resources. For example,
<span class="stt">"libcurses"</span> supports windows on the screen that
are created with <span class="RktSym">newwin</span> and released with <span class="RktSym">delwin</span>:</p><p><table cellspacing="0"><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">WINDOW *newwin(int lines, int ncols, int y, int x);</span></span></p></td></tr><tr><td><p><span class="stt"><span class="hspace">&nbsp;&nbsp;</span><span class="stt">int delwin(WINDOW *win);</span></span></p></td></tr></table></p><p>In a sufficiently complex program, ensuring that every <span class="RktSym">newwin</span>
is paired with <span class="RktSym">delwin</span> can be challenging, especially if the
functions are wrapped by otherwise safe functions that are provided
from a library. A library that is intended to be safe for use in a
sandbox, say, must protect against resource leaks within the Racket
process as a whole when a sandboxed program misbehaves or is
terminated.</p><p>The <a href="Allocation_and_Finalization.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">ffi/unsafe/alloc</span></a> library provides functions to
connect resource-allocating functions and resource-releasing
functions. The library then arranges for finalization to release a resource if
it becomes inaccessible (according to the GC) before it is explicitly
released. At the same time, the library handles tricky atomicity
requirements to ensure that the finalization is properly registered
and never run multiple times.</p><p>Using <a href="Allocation_and_Finalization.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">ffi/unsafe/alloc</span></a>, the <span class="RktSym">newwin</span> and
<span class="RktSym">delwin</span> functions can be imported with <span class="RktSym">allocator</span>
and <span class="RktSym">deallocator</span> wrappers, respectively:</p><blockquote class="SCodeFlow"><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="../reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29" class="RktStxLink" data-pltdoc="x">require</a></span><span class="hspace">&nbsp;</span><span class="RktSym">ffi/unsafe/alloc</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">delwin</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym">_WINDOW-pointer</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">#:wrap</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">deallocator</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">define-curses</span><span class="hspace">&nbsp;</span><span class="RktSym">newwin</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="foreign_procedures.html#%28form._%28%28lib._ffi%2Funsafe..rkt%29.__fun%29%29" class="RktStxLink" data-pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#%28def._%28%28lib._ffi%2Funsafe..rkt%29.__int%29%29" class="RktValLink" data-pltdoc="x">_int</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/function-contracts.html#%28form._%28%28lib._racket%2Fcontract%2Fbase..rkt%29._-~3e%29%29" class="RktStxLink" data-pltdoc="x"><span class="nobreak">-&gt;</span></a></span><span class="hspace">&nbsp;</span><span class="RktSym">_WINDOW-pointer</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">#:wrap</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">allocator</span><span class="hspace">&nbsp;</span><span class="RktSym">delwin</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><p>A <span class="RktSym">deallocator</span> wrapper makes a function cancel any existing
finalizer for the function&rsquo;s argument.  An <span class="RktSym">allocator</span> wrapper
refers to the deallocator, so that the deallocator can be run if
necessary by a finalizer.</p><p>If a resource is scarce or visible to end users, then <a href="../reference/eval-model.html#%28tech._custodian%29" class="techoutside" data-pltdoc="x"><span class="techinside">custodian</span></a> management is more appropriate than
mere finalization as implemented by <span class="RktSym">allocator</span>. See the
<a href="Custodian_Shutdown_Registration.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">ffi/unsafe/custodian</span></a> library.</p><h4>1.8<tt>&nbsp;</tt><a name="(part._.More_.Examples)"></a>More Examples</h4><p>For more examples of common FFI patterns, see the defined interfaces
in the <span class="stt">"ffi/examples"</span> collection. See also [<a href="doc-bibliography.html#%28cite._.Barzilay04%29" data-pltdoc="x">Barzilay04</a>].</p><div class="navsetbottom"><span class="navleft"><form class="searchform"><input class="searchbox" style="color: #888;" type="text" value="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;5.3.2&quot;, &quot;../&quot;);" onfocus="this.style.color=&quot;black&quot;; this.style.textAlign=&quot;left&quot;; if (this.value == &quot;...search manuals...&quot;) this.value=&quot;&quot;;" onblur="if (this.value.match(/^ *$/)) { this.style.color=&quot;#888&quot;; this.style.textAlign=&quot;center&quot;; this.value=&quot;...search manuals...&quot;; }" /></form>&nbsp;&nbsp;<a href="../index.html" title="up to the documentation top" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;5.3.2&quot;);">top</a></span><span class="navright">&nbsp;&nbsp;<a href="index.html" title="backward to &quot;The Racket Foreign Interface&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;The Racket Foreign Interface&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="Loading_Foreign_Libraries.html" title="forward to &quot;2 Loading Foreign Libraries&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>